---
const links = [];
---

<header>
    <nav id="navbar" class="navbar">
        <div class="nav-container">
           
            <!-- Hanging Conclave Logo (appears on scroll) -->
            <img
                data-src="/phi-mu-delta-conclave-2026-192.optimized.webp"
                data-srcset="/phi-mu-delta-conclave-2026-128.optimized.webp 128w,
                             /phi-mu-delta-conclave-2026-192.optimized.webp 192w"
                sizes="(max-width: 768px) 85px, 187px"
                alt="Phi Mu Delta Conclave 2026"
                class="navbar-conclave-logo"
                id="navbar-conclave-logo"
                width="192"
                height="197"
                src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
                loading="lazy"
            />

            <!-- Register Button (right of logo) -->
            <a class="nav-action-btn register-btn" href="#" id="register-btn" aria-label="Preregister for the Conclave">
                <span class="btn-inner">Preregister</span>
            </a>
             <!-- Donate Button (left of logo) -->
             <a class="nav-action-btn sponsor-btn" href="/sponsorship" id="sponsor-btn" aria-label="Become a sponsor">
                <span class="btn-inner">Sponsor</span>
            </a>

            <!-- Navigation Links -->
            <div class="navbar-collapse" id="navbar-collapse">
                <ul class="navbar-nav" id="navbar-nav">
                    {links.map((link) => (
                        <li class="glass-item">
                            <span class="shine"></span>
                            <span class="glow"></span>
                            <a href={link.to}>{link.label}</a>
                        </li>
                    ))}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Scroll to Top Button -->
    <a href="/#home" class="scroll-top" id="scroll-top" aria-label="Scroll to top">
        <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
        </svg>
    </a>
</header>

<style>
    /* Variables */
    :root {
        --nav-height: 70px;
        --nav-bg: transparent;
        --nav-text: #9ca3af;
        --nav-text-active: #ea7600;
        --nav-font-size: 14px;

        /* Glass effect vars */
        --glass-border: 1px;
        --glass-border-color: rgba(234, 118, 0, 0.25);
        --glass-radius: 12px;
        --glass-ease: cubic-bezier(0.5, 1, 0.89, 1);
    }

    /* Navbar Base */
    .navbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: var(--nav-height);
        background: var(--nav-bg);
        border: none;
        z-index: 1000;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .nav-container {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        height: 100%;
        width: 100%;
        padding: 0 1rem;
    }

    @media (min-width: 640px) {
        .nav-container {
            padding: 0 1.5rem;
        }
    }

    @media (min-width: 1024px) {
        .nav-container {
            padding: 0 2rem;
        }
    }

    /* Hanging Conclave Logo */
    .navbar-conclave-logo {
        position: absolute;
        left: 50%;
        top: 100%;
        transform: translateX(-50%) translateY(-30%);
        height: auto;
        width: clamp(85px, 21.25vw, 187px);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
        z-index: 100;
        pointer-events: none;
    }

    .navbar-conclave-logo.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }

    /* Action Buttons */
    .nav-action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 100px;
        border: 1px solid rgba(255, 255, 255, 0.35);
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.18);
        position: absolute;
        top: 100%;
        transform: translateY(-30%);
        padding: 0;
        text-decoration: none;
        transition: opacity 0.2s ease, visibility 0.2s ease;
        opacity: 0;
        visibility: hidden;
        z-index: 100;
        pointer-events: none;
    }

    .nav-action-btn.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }

    .register-btn {
        left: calc(50% + clamp(42.5px, 10.625vw, 93.5px) + 1.5rem);
    }
    .sponsor-btn {
        right: calc(50% + clamp(42.5px, 10.625vw, 93.5px) + 1.5rem);
    }

    .btn-inner {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        padding: 0.6rem 2rem;
        border-radius: 100px;
        font-family: 'Inter', sans-serif;
        font-weight: 800;
        font-size: 0.9375rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        z-index: 1;
        background: rgba(255, 255, 255, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.42);
        backface-visibility: hidden;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.25);
    }

    .register-btn .btn-inner {
        color: #212322;
    }

    .sponsor-btn .btn-inner {
        color: #212322;
    }

    .nav-action-btn:hover .btn-inner {
        background: rgba(255, 255, 255, 0.28);
        border-color: rgba(255, 255, 255, 0.58);
    }

    /* Mobile button positioning */
    @media (max-width: 768px) {
        .sponsor-btn {
            right: calc(50% + clamp(42.5px, 10.625vw, 93.5px) + 1rem);
        }

        .register-btn {
            left: calc(50% + clamp(42.5px, 10.625vw, 93.5px) + 1rem);
        }

        .btn-inner {
            padding: 0.5rem 1.25rem;
            font-size: 0.8125rem;
            letter-spacing: 0.5px;
        }
    }

    /* Navbar Collapse */
    .navbar-collapse {
        display: none;
        position: absolute;
        top: var(--nav-height);
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        padding: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .navbar-collapse.show {
        display: block;
    }

    @media (min-width: 768px) {
        .navbar-collapse {
            display: flex;
            position: absolute;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            backdrop-filter: none;
            padding: 0;
            box-shadow: none;
        }
    }

    /* Navigation Links */
    .navbar-nav {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        list-style: none;
        margin: 0;
        padding: 0;
        width: 100%;
    }

    @media (min-width: 768px) {
        .navbar-nav {
            flex-direction: row;
            align-items: center;
            width: auto;
        }
    }

    /* Scroll to Top Button */
    .scroll-top {
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed;
        right: 20px;
        bottom: 20px;
        width: 44px;
        height: 44px;
        color: white;
        background: var(--nav-text-active);
        border-radius: 50%;
        box-shadow: 2px 2px 12px rgba(0, 0, 0, 0.2);
        transform: translateY(80px);
        transition: transform 0.2s ease-in, opacity 0.2s ease;
        opacity: 0.7;
        z-index: 999;
    }

    .scroll-top:hover {
        opacity: 1;
    }

    .scroll-top.show-button {
        transform: translateY(0);
    }

    .scroll-top svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
    }

    /* Focus section animation */
    :global(section.focus .section-header) {
        color: var(--nav-text-active);
    }
</style>

<script>
    // Elements
    const navbar = document.getElementById('navbar') as HTMLElement;
    const navbarNav = document.getElementById('navbar-nav') as HTMLElement;
    const scrollTopBtn = document.getElementById('scroll-top') as HTMLElement;
    const navLinks = navbarNav.querySelectorAll('a');
    const heroConclaveLogo = document.getElementById('hero-conclave-logo') as HTMLElement;
    const navbarConclaveLogo = document.getElementById('navbar-conclave-logo') as HTMLImageElement;
    const registerBtn = document.getElementById('register-btn') as HTMLElement;
    const sponsorBtn = document.getElementById('sponsor-btn') as HTMLElement;

    // Smooth scroll and active state
    navLinks.forEach((link) => {
        link.addEventListener('click', (e) => {
            const href = link.getAttribute('href');

            if (href && href.startsWith('/#')) {
                e.preventDefault();
                const targetId = href.substring(2);
                const targetElement = document.getElementById(targetId);

                // Remove active from all, add to current
                navbarNav.querySelectorAll('.glass-item').forEach(item => item.classList.remove('active'));
                link.closest('.glass-item')?.classList.add('active');

                // Add focus effect to target section
                document.querySelectorAll('section').forEach(s => s.classList.remove('focus'));
                targetElement?.classList.add('focus');

                // Remove focus class after animation
                setTimeout(() => {
                    targetElement?.classList.remove('focus');
                }, 2000);

                if (targetElement) {
                    const navHeight = navbar.offsetHeight;
                    const targetPosition = targetElement.offsetTop - navHeight;

                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });
                }
            }
        });
    });

    // Home link smooth scroll
    const homeLinks = document.querySelectorAll('a[href="/#home"]');
    homeLinks.forEach((link) => {
        link.addEventListener('click', (e) => {
            e.preventDefault();

            // Remove all active states
            navbarNav.querySelectorAll('.glass-item').forEach(item => item.classList.remove('active'));

            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    });

    // Cache layout values to avoid forced reflows
    let cachedNavHeight = navbar.offsetHeight;
    let sectionPositions: Array<{id: string, top: number, bottom: number}> = [];
    const sections = document.querySelectorAll('section[id]');
    
    function cacheSectionPositions() {
        cachedNavHeight = navbar.offsetHeight;
        sectionPositions = Array.from(sections).map(section => {
            const el = section as HTMLElement;
            return {
                id: section.getAttribute('id') || '',
                top: el.offsetTop - cachedNavHeight - 100,
                bottom: el.offsetTop + el.offsetHeight - cachedNavHeight - 100
            };
        });
    }
    
    // Cache on load and resize (debounced)
    cacheSectionPositions();
    let resizeTimeout: number;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = window.setTimeout(cacheSectionPositions, 150);
    });

    // Throttle scroll handler with rAF
    let ticking = false;
    let hasLoadedNavbarLogo = false;

    function loadNavbarLogo() {
        if (!navbarConclaveLogo || hasLoadedNavbarLogo) return;

        const deferredSrc = navbarConclaveLogo.dataset.src;
        const deferredSrcset = navbarConclaveLogo.dataset.srcset;
        if (!deferredSrc) return;

        navbarConclaveLogo.src = deferredSrc;
        if (deferredSrcset) {
            navbarConclaveLogo.srcset = deferredSrcset;
        }
        hasLoadedNavbarLogo = true;
    }
    
    function handleScroll() {
        const scrollPos = window.scrollY;

        // Show/hide scroll-top button (cheap class toggle)
        scrollTopBtn.classList.toggle('show-button', scrollPos > 50);

        // Update active nav item using cached positions
        for (const section of sectionPositions) {
            if (scrollPos >= section.top && scrollPos < section.bottom) {
                navbarNav.querySelectorAll('.glass-item').forEach(item => item.classList.remove('active'));
                const activeLink = navbarNav.querySelector(`a[href="/#${section.id}"]`);
                activeLink?.closest('.glass-item')?.classList.add('active');
                break; // Only one section can be active
            }
        }

        // Show/hide hanging logo and buttons (use cached navHeight)
        if (heroConclaveLogo && navbarConclaveLogo && registerBtn && sponsorBtn) {
            const heroLogoRect = heroConclaveLogo.getBoundingClientRect();
            const showNavItems = heroLogoRect.top < cachedNavHeight;
            if (showNavItems) {
                loadNavbarLogo();
            }
            
            navbarConclaveLogo.classList.toggle('show', showNavItems);
            registerBtn.classList.toggle('show', showNavItems);
            sponsorBtn.classList.toggle('show', showNavItems);
            heroConclaveLogo.classList.toggle('faded', showNavItems);
        }
        
        ticking = false;
    }
    
    function onScroll() {
        if (!ticking) {
            requestAnimationFrame(handleScroll);
            ticking = true;
        }
    }

    // Initial check and scroll listener
    handleScroll();
    window.addEventListener('scroll', onScroll, { passive: true });

    // Preregister button opens modal
    if (registerBtn) {
        registerBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.dispatchEvent(new CustomEvent('open-preregister-modal'));
        });
    }
</script>
